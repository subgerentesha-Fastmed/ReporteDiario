<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Reporte Diario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #001f3f, #8B0000);
            min-height: 100vh;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #1e3a8a;
            color: white;
            border-bottom: 3px solid #f59e0b;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: #2d3748;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
        }
        .copyright {
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
            background: rgba(0, 0, 0, 0.3);
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #1f2937;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 relative">

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-4xl mb-16">
        <div class="flex flex-col items-center mb-6">
            <img src="https://static.wixstatic.com/media/8b1764_8e8af4e9fbd54ef085bc68a18999d35d~mv2.png/v1/fill/w_540,h_222,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/2-fondo%20blanco%20horizontal%202.png" alt="Logo SHA-PROSALMED" class="h-20 mb-4">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Herramienta de Reporte Diario</h1>
        </div>

        <!-- Tab Buttons -->
        <div class="flex justify-center border-b-2 border-gray-200 mb-6">
            <button id="tab-reporte" class="tab-button px-6 py-3 font-semibold text-gray-600 active focus:outline-none">Reporte Diario</button>
            <button id="tab-supervisor" class="tab-button px-6 py-3 font-semibold text-gray-600 focus:outline-none">Panel Supervisor</button>
        </div>

        <!-- Reporte Diario Tab -->
        <div id="content-reporte">
            <form id="daily-report-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="responsable" class="block text-sm font-medium text-gray-700">SESS/Responsable</label>
                        <input type="text" id="responsable" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: T.S.U. Hover Bogado" required>
                    </div>
                    <div>
                        <label for="soc" class="block text-sm font-medium text-gray-700">SOC</label>
                        <input type="number" id="soc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="actosInseguros" class="block text-sm font-medium text-gray-700">Actos Inseguros</label>
                        <input type="number" id="actosInseguros" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="nearMiss" class="block text-sm font-medium text-gray-700">NEAR MISS</label>
                        <input type="number" id="nearMiss" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="ciAbiertas" class="block text-sm font-medium text-gray-700">Condiciones Inseguras Abiertas</label>
                        <input type="number" id="ciAbiertas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="ciCerradas" class="block text-sm font-medium text-gray-700">Condiciones Inseguras Cerradas</label>
                        <input type="number" id="ciCerradas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="ptPepsico" class="block text-sm font-medium text-gray-700">Permiso de Trabajo Pepsico</label>
                        <input type="number" id="ptPepsico" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="ptContr" class="block text-sm font-medium text-gray-700">Permiso de Trabajo Contratista</label>
                        <input type="number" id="ptContr" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="noPersonasEntrenadas" class="block text-sm font-medium text-gray-700">No Personas Entrenadas</label>
                        <input type="number" id="noPersonasEntrenadas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="inspRealizadas" class="block text-sm font-medium text-gray-700">Inspecciones Realizadas</label>
                        <input type="number" id="inspRealizadas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div>
                        <label for="accidentes" class="block text-sm font-medium text-gray-700">Accidentes</label>
                        <input type="number" id="accidentes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" min="0" value="0">
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-3">
                        <label for="temaAdiestramiento" class="block text-sm font-medium text-gray-700">Tema de Adiestramiento</label>
                        <input type="text" id="temaAdiestramiento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Liderazgo/pol√≠tica de sustentabilidad ambiental">
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="horarioInicio" class="block text-sm font-medium text-gray-700">Horario de Inicio</label>
                            <input type="time" id="horarioInicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="horarioFin" class="block text-sm font-medium text-gray-700">Horario de Fin</label>
                            <input type="time" id="horarioFin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="areaInsp" class="block text-sm font-medium text-gray-700">√Åreas de Inspecci√≥n (separadas por coma)</label>
                    <input type="text" id="areaInsp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Proceso, Empaque">
                </div>
                <div class="mt-4">
                    <label for="resumen" class="block text-sm font-medium text-gray-700">Resumen del Turno</label>
                    <textarea id="resumen" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Se realiz√≥ recorrido por planta, se asisti√≥ a la junta de planificaci√≥n, etc."></textarea>
                </div>

                <div class="flex flex-col sm:flex-row justify-center mt-6 gap-4">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                        Guardar Reporte
                    </button>
                    <button type="button" id="whatsapp-button" class="w-full sm:w-auto px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 transition-transform transform hover:scale-105">
                        Enviar por WhatsApp
                    </button>
                </div>
            </form>
        </div>

        <!-- Panel Supervisor Tab -->
        <div id="content-supervisor" class="hidden">
            <div id="supervisor-login" class="flex flex-col items-center space-y-4">
                <p class="text-lg font-semibold text-gray-700">Ingresa la clave de supervisor</p>
                <input type="password" id="supervisor-key" class="w-full max-w-xs p-2 border rounded-md" placeholder="Clave de acceso">
                <button id="login-button" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Acceder
                </button>
            </div>
            
            <div id="supervisor-dashboard" class="hidden">
                <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
                    <h2 class="text-xl font-bold text-gray-800">Informe de Gesti√≥n</h2>
                    <div class="flex flex-col md:flex-row items-center gap-2">
                         <select id="filter-period" class="p-2 border rounded-md">
                            <option value="all">Todo el Per√≠odo</option>
                            <option value="week">√öltima Semana</option>
                            <option value="month">√öltimo Mes</option>
                        </select>
                        <select id="filter-user" class="p-2 border rounded-md"></select>
                        <button id="apply-filters-button" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
                            Aplicar Filtros
                        </button>
                    </div>
                    <button id="export-excel-button" class="bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700 transition">
                        Exportar a Excel
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row justify-center mt-6 gap-4">
                    <button id="generate-report-button" class="w-full sm:w-auto px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Generar Informe de Gesti√≥n
                    </button>
                </div>
                
                <div class="flex flex-col lg:flex-row gap-6 mb-6 mt-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex-1">
                        <h3 class="font-semibold text-lg mb-2 text-gray-700">Reportes Cargados</h3>
                        <div id="reports-list" class="space-y-2 max-h-64 overflow-y-auto">
                           <p class="text-gray-500 text-center">Cargando reportes...</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex-1">
                        <h3 class="font-semibold text-lg mb-2 text-gray-700">Estado de M√©tricas</h3>
                        <canvas id="metric-chart"></canvas>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">Tendencia de M√©tricas Clave</h3>
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Report Modal -->
    <div id="report-modal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <div id="detailed-report-content" class="prose max-w-none">
                <!-- Report content will be injected here -->
            </div>
            <div class="flex justify-end mt-6">
                 <button id="export-word-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    Exportar a Word
                 </button>
            </div>
        </div>
    </div>
    
    <footer class="copyright">
        Derechos Reservados &copy; 2025 SHA-PROSALMED
    </footer>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Message Box Function
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // --- Firebase Initialization and Auth ---
        let app;
        let db;
        let auth;
        let userId = 'anonymous';
        let allReports = [];
        let filteredReports = [];
        let unsubscribeReports = null; // To prevent duplicate listeners

        window.addEventListener('load', async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            // Now that we have a user, we can safely load the data
                            loadReports();
                        } else {
                            // If no user, attempt to sign in. The listener will be called again with the new user object.
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Error during sign-in:", error);
                                showMessage("Error al iniciar sesi√≥n.");
                            }
                        }
                    });
                    
                    setupEventListeners();
                } else {
                    console.error("Firebase config is missing.");
                    showMessage("Error: Configuraci√≥n de Firebase no disponible.");
                }
            } catch (error)
                {
                console.error("Error initializing Firebase:", error);
                showMessage("Error: No se pudo iniciar Firebase.");
            }
        });
        
        // --- UI Logic and Event Listeners ---
        function setupEventListeners() {
            const tabs = {
                'tab-reporte': 'content-reporte',
                'tab-supervisor': 'content-supervisor'
            };
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#content-reporte, #content-supervisor').forEach(content => content.classList.add('hidden'));
                    button.classList.add('active');
                    document.getElementById(tabs[button.id]).classList.remove('hidden');
                });
            });

            document.getElementById('daily-report-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('login-button').addEventListener('click', handleSupervisorLogin);
            document.getElementById('export-excel-button').addEventListener('click', exportToExcel);
            document.getElementById('apply-filters-button').addEventListener('click', applyFilters);
            document.getElementById('whatsapp-button').addEventListener('click', sendWhatsAppReport);
            document.getElementById('generate-report-button').addEventListener('click', showDetailedReport);
            document.querySelector('.modal-close-button').addEventListener('click', () => {
                document.getElementById('report-modal').classList.add('hidden');
            });
            document.getElementById('export-word-button').addEventListener('click', exportToWord);
        }

        // --- Data Handling ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const reportData = {
                timestamp: serverTimestamp(),
                userId: userId,
                responsable: form.responsable.value,
                temaAdiestramiento: form.temaAdiestramiento.value,
                horarioInicio: form.horarioInicio.value,
                horarioFin: form.horarioFin.value,
                soc: parseInt(form.soc.value) || 0,
                actosInseguros: parseInt(form.actosInseguros.value) || 0,
                nearMiss: parseInt(form.nearMiss.value) || 0,
                ciAbiertas: parseInt(form.ciAbiertas.value) || 0,
                ciCerradas: parseInt(form.ciCerradas.value) || 0,
                ptPepsico: parseInt(form.ptPepsico.value) || 0,
                ptContr: parseInt(form.ptContr.value) || 0,
                noPersonasEntrenadas: parseInt(form.noPersonasEntrenadas.value) || 0,
                inspRealizadas: parseInt(form.inspRealizadas.value) || 0,
                accidentes: parseInt(form.accidentes.value) || 0,
                areaInsp: form.areaInsp.value,
                resumen: form.resumen.value,
            };

            try {
                const reportsColRef = collection(db, `artifacts/${appId}/public/data/dailyReports`);
                await addDoc(reportsColRef, reportData);
                showMessage('Reporte guardado exitosamente.');
                form.reset();
            } catch (error) {
                console.error("Error saving document:", error);
                showMessage('Error al guardar el reporte. Por favor, revisa tu conexi√≥n a internet.');
            }
        }
        
        function sendWhatsAppReport() {
            const form = document.getElementById('daily-report-form');
            const data = {
                responsable: form.responsable.value || 'N/A',
                soc: parseInt(form.soc.value) || 0,
                actosInseguros: parseInt(form.actosInseguros.value) || 0,
                nearMiss: parseInt(form.nearMiss.value) || 0,
                ciAbiertas: parseInt(form.ciAbiertas.value) || 0,
                ciCerradas: parseInt(form.ciCerradas.value) || 0,
                ptPepsico: parseInt(form.ptPepsico.value) || 0,
                ptContr: parseInt(form.ptContr.value) || 0,
                noPersonasEntrenadas: parseInt(form.noPersonasEntrenadas.value) || 0,
                inspRealizadas: parseInt(form.inspRealizadas.value) || 0,
                accidentes: parseInt(form.accidentes.value) || 0,
                temaAdiestramiento: form.temaAdiestramiento.value || 'N/A',
                horarioInicio: form.horarioInicio.value || 'N/A',
                horarioFin: form.horarioFin.value || 'N/A',
                areaInsp: form.areaInsp.value || 'N/A',
                resumen: form.resumen.value || 'Sin resumen',
            };

            const today = new Date().toLocaleDateString('es-ES');
            const message = `
*Reporte Diario de Seguridad* üìã
*Fecha:* ${today}
*Responsable:* ${data.responsable}

*üìä Estad√≠sticas:*
*üßê SOC:* ${data.soc}
*üß† Actos Inseguros:* ${data.actosInseguros}
*‚úÖ NEAR MISS:* ${data.nearMiss}
*‚úÖ CI Abiertas:* ${data.ciAbiertas}
*‚úÖ CI Cerradas:* ${data.ciCerradas}
*üöß PT Pepsico:* ${data.ptPepsico}
*üöß PT Contratista:* ${data.ptContr}
*üßë‚Äçü§ù‚Äçüßë Personas Entrenadas:* ${data.noPersonasEntrenadas}
*‚úÖ Inspecciones Realizadas:* ${data.inspRealizadas}
*üí• Accidentes:* ${data.accidentes}

*üßë‚Äçüè´ Adiestramiento:*
- *Tema:* ${data.temaAdiestramiento}
- *Horario:* ${data.horarioInicio} - ${data.horarioFin}

*üó∫Ô∏è √Åreas Inspeccionadas:* ${data.areaInsp}

*‚úçÔ∏è Resumen del Turno:*
${data.resumen}
`;
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        const SUPERVISOR_KEY = 'pepsico2025';
        let chartInstances = {};

        async function handleSupervisorLogin() {
            const key = document.getElementById('supervisor-key').value;
            if (key === SUPERVISOR_KEY) {
                document.getElementById('supervisor-login').classList.add('hidden');
                document.getElementById('supervisor-dashboard').classList.remove('hidden');
                showMessage('Acceso de supervisor concedido.');
                applyFilters();
            } else {
                showMessage('Clave incorrecta. Int√©ntalo de nuevo.');
            }
        }
        
        function loadReports() {
            if (!db) return;

            // Prevent attaching multiple listeners if this function gets called more than once.
            if (unsubscribeReports) {
                unsubscribeReports();
            }

            const reportsColRef = collection(db, `artifacts/${appId}/public/data/dailyReports`);
            unsubscribeReports = onSnapshot(reportsColRef, (snapshot) => {
                allReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allReports.sort((a, b) => {
                    const tsA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const tsB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return tsB - tsA;
                });
                populateUserFilter();
                applyFilters();
            }, (error) => {
                console.error("Error in snapshot listener:", error);
                showMessage("Error al cargar los reportes: Permisos insuficientes.");
            });
        }
        
        function populateUserFilter() {
            const userFilter = document.getElementById('filter-user');
            userFilter.innerHTML = '<option value="all">Todos los Responsables</option>';
            const uniqueUsers = [...new Set(allReports.map(r => r.responsable).filter(Boolean))];
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user.substring(0, 20) + (user.length > 20 ? '...' : '');
                userFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const periodFilter = document.getElementById('filter-period').value;
            const userFilter = document.getElementById('filter-user').value;
            filteredReports = [...allReports];

            if (userFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.responsable === userFilter);
            }
            
            if (periodFilter !== 'all') {
                const now = new Date();
                let pastDate;
                if (periodFilter === 'week') {
                    pastDate = new Date();
                    pastDate.setDate(now.getDate() - 7);
                } else if (periodFilter === 'month') {
                    pastDate = new Date();
                    pastDate.setMonth(now.getMonth() - 1);
                }
                filteredReports = filteredReports.filter(report => report.timestamp && report.timestamp.toDate() >= pastDate);
            }
            
            renderReports(filteredReports);
            renderCharts(filteredReports);
        }

        function renderReports(reportsToRender) {
            const reportsListDiv = document.getElementById('reports-list');
            reportsListDiv.innerHTML = '';
            if (reportsToRender.length === 0) {
                reportsListDiv.innerHTML = '<p class="text-gray-500 text-center">No hay reportes disponibles para este filtro.</p>';
                return;
            }
            reportsToRender.forEach(report => {
                const date = report.timestamp ? report.timestamp.toDate().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Fecha no disponible';
                const time = report.timestamp ? report.timestamp.toDate().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                const responsable = report.responsable || 'An√≥nimo';
                const reportDiv = document.createElement('div');
                reportDiv.classList.add('bg-gray-100', 'p-2', 'rounded-md', 'border', 'border-gray-200');
                reportDiv.innerHTML = `
                    <p class="font-semibold text-gray-800">Reporte del ${date} a las ${time}</p>
                    <p class="text-sm text-gray-600">Responsable: ${responsable}</p>
                    <div class="mt-2 text-xs text-gray-500">
                        <p>SOC: ${report.soc} | CI Abiertas: ${report.ciAbiertas} | NEAR MISS: ${report.nearMiss}</p>
                    </div>
                `;
                reportsListDiv.appendChild(reportDiv);
            });
        }
        
        function renderCharts(reportsToRender) {
             if (chartInstances.metricChart) chartInstances.metricChart.destroy();
             if (chartInstances.trendChart) chartInstances.trendChart.destroy();
             
            if (reportsToRender.length === 0) {
                return;
            }

            const metricLabels = ['SOC', 'CI Abiertas', 'CI Cerradas', 'NEAR MISS', 'Insp. Realizadas'];
            const metricData = {
                soc: reportsToRender.reduce((sum, r) => sum + (r.soc || 0), 0),
                ciAbiertas: reportsToRender.reduce((sum, r) => sum + (r.ciAbiertas || 0), 0),
                ciCerradas: reportsToRender.reduce((sum, r) => sum + (r.ciCerradas || 0), 0),
                nearMiss: reportsToRender.reduce((sum, r) => sum + (r.nearMiss || 0), 0),
                inspRealizadas: reportsToRender.reduce((sum, r) => sum + (r.inspRealizadas || 0), 0)
            };
            const metricValues = Object.values(metricData);
            
            const metricCtx = document.getElementById('metric-chart').getContext('2d');
            chartInstances.metricChart = new Chart(metricCtx, {
                type: 'bar',
                data: {
                    labels: metricLabels,
                    datasets: [{
                        label: 'Total Acumulado',
                        data: metricValues,
                        backgroundColor: [
                            '#4a90e2', '#d9534f', '#5cb85c', '#f0ad4e', '#5bc0de'
                        ],
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Total de M√©tricas' }
                    }
                }
            });

            const trendLabels = reportsToRender.map(r => r.timestamp ? r.timestamp.toDate().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }) : '').reverse();
            const socData = reportsToRender.map(r => r.soc || 0).reverse();
            const ciAbiertasData = reportsToRender.map(r => r.ciAbiertas || 0).reverse();
            const nearMissData = reportsToRender.map(r => r.nearMiss || 0).reverse();

            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            chartInstances.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        { label: 'SOC', data: socData, borderColor: '#4a90e2', tension: 0.4, fill: false },
                        { label: 'Condiciones Inseguras Abiertas', data: ciAbiertasData, borderColor: '#d9534f', tension: 0.4, fill: false },
                        { label: 'NEAR MISS', data: nearMissData, borderColor: '#f0ad4e', tension: 0.4, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Tendencia de Reportes a lo largo del tiempo' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function exportToExcel() {
            // 1. Define Goals and Metric Mappings
            const weeklyGoals = {
                'SOC': { value: 3, text: "3", rule: 'exact' },
                'CI ABIERTAS': { value: 4, text: ">=4", rule: 'gte' },
                'CI CERRADAS': { value: 3, text: "3", rule: 'exact' },
                'NEAR MISS': { value: null, text: "Cuando Ocurran", rule: 'when_occurs' },
                'PT Pepsico': { value: null, text: "Cuando Ocurran", rule: 'when_occurs' },
                'PT Contr': { value: null, text: "Cuando Ocurran", rule: 'when_occurs' },
                'ENTRE PEPS': { value: 50, text: ">=50", rule: 'gte' },
                'INPS REALIZADAS': { value: 10, text: ">=10", rule: 'gte' },
                'ACCIDENTES': { value: 0, text: "0", rule: 'exact_zero' }
            };

            const metricKeys = [
                'SOC', 'CI ABIERTAS', 'CI CERRADAS', 'NEAR MISS',
                'PT Pepsico', 'PT Contr', 'ENTRE PEPS', 'INPS REALIZADAS', 'ACCIDENTES'
            ];

            const formToMetricMap = {
                soc: 'SOC',
                ciAbiertas: 'CI ABIERTAS',
                ciCerradas: 'CI CERRADAS',
                nearMiss: 'NEAR MISS',
                ptPepsico: 'PT Pepsico',
                ptContr: 'PT Contr',
                noPersonasEntrenadas: 'ENTRE PEPS',
                inspRealizadas: 'INPS REALIZADAS',
                accidentes: 'ACCIDENTES'
            };
            
            // 2. Get data for the most recent week from filteredReports
            if (filteredReports.length === 0) {
                showMessage("No hay datos filtrados para exportar.");
                return;
            }

            const reportsWithDate = filteredReports.filter(r => r.timestamp && r.timestamp.toDate);
            if (reportsWithDate.length === 0) {
                 showMessage("No hay reportes con fecha v√°lida para exportar.");
                return;
            }

            const latestDate = new Date(Math.max(...reportsWithDate.map(r => r.timestamp.toDate())));
            const weekEnd = new Date(latestDate);
            weekEnd.setDate(latestDate.getDate() - latestDate.getDay() + 7);
            weekEnd.setHours(23, 59, 59, 999);
            
            const weekStart = new Date(weekEnd);
            weekStart.setDate(weekEnd.getDate() - 7);
            weekStart.setHours(0, 0, 0, 0);

            const weeklyReports = reportsWithDate.filter(r => {
                const reportDate = r.timestamp.toDate();
                return reportDate >= weekStart && reportDate <= weekEnd;
            });

            if (weeklyReports.length === 0) {
                showMessage("No hay reportes en la √∫ltima semana para exportar.");
                return;
            }

            // 3. Aggregate data by responsible and day
            const responsables = [...new Set(weeklyReports.map(r => r.responsable).filter(Boolean))];
            const dailyData = {};

            responsables.forEach(r => {
                dailyData[r] = {};
                metricKeys.forEach(mKey => {
                    dailyData[r][mKey] = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 }; // Mon-Sun
                });
            });
            
            weeklyReports.forEach(report => {
                const dayIndex = (report.timestamp.toDate().getDay() + 6) % 7;
                const responsable = report.responsable;
                if (responsable) {
                    for (const formKey in formToMetricMap) {
                        const metricKey = formToMetricMap[formKey];
                        dailyData[responsable][metricKey][dayIndex] += (report[formKey] || 0);
                    }
                }
            });

            // 4. Build array of arrays for the sheet
            const sheetData = [];
            const days = ['L', 'M', 'M', 'J', 'V', 'S', 'D', 'To'];
            const complianceHeaders = [''].concat(responsables).concat(['Cumplimiento']);

            let headerRow1 = ['', 'Obj Semana'];
            responsables.forEach(name => {
                headerRow1.push(name);
                for (let i = 0; i < days.length - 1; i++) headerRow1.push('');
            });
            headerRow1.push('', 'Cumplimiento');
            sheetData.push(headerRow1);

            let headerRow2 = ['', ''];
            responsables.forEach(() => headerRow2.push(...days));
            headerRow2.push('', ...complianceHeaders);
            sheetData.push(headerRow2);
            
            metricKeys.forEach(metricKey => {
                let row = [metricKey, weeklyGoals[metricKey].text];
                const personTotals = [];
                responsables.forEach(responsable => {
                    let total = 0;
                    for(let i=0; i<7; i++) {
                        const val = dailyData[responsable][metricKey][i] || 0;
                        row.push(val);
                        total += val;
                    }
                    row.push(total);
                    personTotals.push(total);
                });
                
                row.push('', metricKey, ...personTotals);
                
                const metricGoal = weeklyGoals[metricKey];
                let complianceText = 'No Ejecutado';
                const grandTotal = personTotals.reduce((a, b) => a + b, 0);

                if (metricGoal.rule === 'when_occurs') {
                    complianceText = grandTotal > 0 ? 'Ejecutado' : 'No Ejecutado';
                } else if (metricGoal.rule === 'exact_zero') {
                    complianceText = grandTotal === 0 ? '100%' : '0%';
                } else if (metricGoal.rule === 'gte') {
                    const totalGoal = metricGoal.value * responsables.length;
                    complianceText = grandTotal >= totalGoal ? 'VERDADERO' : 'FALSO';
                } else if (metricGoal.rule === 'exact') {
                     const totalGoal = metricGoal.value * responsables.length;
                     if (totalGoal > 0) {
                        const percentage = Math.round((grandTotal / totalGoal) * 100);
                        complianceText = `${percentage}%`;
                     } else {
                        complianceText = grandTotal === 0 ? '100%' : '0%';
                     }
                }
                row.push(complianceText);
                sheetData.push(row);
            });

            // 5. Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const merges = [];
            responsables.forEach((name, i) => {
                merges.push({ s: { r: 0, c: 2 + i * 8 }, e: { r: 0, c: 2 + i * 8 + 7 } });
            });
            const complianceStartCol = 2 + responsables.length * 8 + 1;
            merges.push({ s: { r: 0, c: complianceStartCol }, e: { r: 0, c: complianceStartCol + complianceHeaders.length -1 } });
            ws['!merges'] = merges;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Semanal");
            XLSX.writeFile(wb, "Reporte_Semanal_Gestion.xlsx");
            showMessage('Reporte semanal exportado a Excel.');
        }

        function showDetailedReport() {
            const reportModal = document.getElementById('report-modal');
            const contentDiv = document.getElementById('detailed-report-content');

            if (filteredReports.length === 0) {
                contentDiv.innerHTML = '<p class="text-center text-gray-600">No hay reportes para generar un informe. Por favor, ajusta los filtros.</p>';
                reportModal.classList.remove('hidden');
                return;
            }

            // --- Calculate Totals ---
            const totalReports = filteredReports.length;
            const totalSoc = filteredReports.reduce((sum, r) => sum + (r.soc || 0), 0);
            const totalCiAbiertas = filteredReports.reduce((sum, r) => sum + (r.ciAbiertas || 0), 0);
            const totalCiCerradas = filteredReports.reduce((sum, r) => sum + (r.ciCerradas || 0), 0);
            const totalNearMiss = filteredReports.reduce((sum, r) => sum + (r.nearMiss || 0), 0);
            const totalAccidentes = filteredReports.reduce((sum, r) => sum + (r.accidentes || 0), 0);
            const totalActosInseguros = filteredReports.reduce((sum, r) => sum + (r.actosInseguros || 0), 0);
            const totalInspRealizadas = filteredReports.reduce((sum, r) => sum + (r.inspRealizadas || 0), 0);

            // --- Auto-generate Conclusions ---
            let generatedConclusions = '<ul class="list-disc list-inside">';
            generatedConclusions += `<li>Durante el per√≠odo analizado, se procesaron un total de <strong>${totalReports}</strong> reportes.</li>`;
            if (totalAccidentes === 0) {
                generatedConclusions += `<li>El resultado m√°s destacable es la <strong>ausencia de accidentes reportados</strong>, lo cual refleja un entorno de trabajo seguro.</li>`;
            } else {
                generatedConclusions += `<li>Se registr√≥ un total de <strong>${totalAccidentes}</strong> accidente(s), lo cual requiere atenci√≥n prioritaria.</li>`;
            }
             if (totalCiAbiertas > totalCiCerradas) {
                generatedConclusions += `<li>Se observa un √°rea de oportunidad en la gesti√≥n de condiciones inseguras, ya que el n√∫mero de condiciones abiertas (${totalCiAbiertas}) supera al de cerradas (${totalCiCerradas}).</li>`;
            } else {
                generatedConclusions += `<li>La gesti√≥n de condiciones inseguras muestra un balance positivo, con <strong>${totalCiCerradas}</strong> condiciones cerradas frente a <strong>${totalCiAbiertas}</strong> abiertas.</li>`;
            }
            if (totalNearMiss > 0) {
                generatedConclusions += `<li>El reporte de <strong>${totalNearMiss} NEAR MISS</strong> indica una cultura proactiva en la identificaci√≥n de potenciales incidentes.</li>`;
            }
            generatedConclusions += '</ul>';

            // --- Auto-generate Recommendations ---
            let generatedRecommendations = '<ul class="list-disc list-inside">';
             if (totalAccidentes > 0) {
                generatedRecommendations += `<li><strong>Investigar a fondo</strong> las causas de los ${totalAccidentes} accidente(s) reportado(s) y establecer planes de acci√≥n correctivos inmediatos.</li>`;
            }
            if (totalCiAbiertas > totalCiCerradas) {
                generatedRecommendations += `<li>Priorizar y <strong>asignar recursos para el cierre</strong> de las ${totalCiAbiertas} condiciones inseguras abiertas para mitigar riesgos potenciales.</li>`;
            }
            if (totalActosInseguros > 0) {
                 generatedRecommendations += `<li>Realizar <strong>sesiones de refuerzo y adiestramiento</strong> enfocadas en los procedimientos seguros para disminuir la ocurrencia de los ${totalActosInseguros} actos inseguros detectados.</li>`;
            }
            generatedRecommendations += `<li>Continuar fomentando el reporte de NEAR MISS y SOCs para mantener una cultura de prevenci√≥n activa.</li>`;
            generatedRecommendations += '</ul>';


            const reportHtml = `
                <h1 class="text-2xl font-bold mb-4">Informe de Gesti√≥n</h1>
                <p class="text-sm text-gray-500 mb-6">Generado para el per√≠odo filtrado.</p>

                <h2 class="text-xl font-bold mb-2">Resumen General</h2>
                <ul class="list-disc list-inside space-y-1 mb-6">
                    <li>Total de Reportes: ${totalReports}</li>
                    <li>Total de SOC: ${totalSoc}</li>
                    <li>Total de CI Abiertas: ${totalCiAbiertas}</li>
                    <li>Total de NEAR MISS: ${totalNearMiss}</li>
                    <li>Total de Accidentes: ${totalAccidentes}</li>
                </ul>

                <h2 class="text-xl font-bold mb-2">Detalle por Reporte</h2>
                <div class="space-y-4 mb-6">
                    ${filteredReports.map(r => `
                        <div class="p-4 border rounded-md bg-gray-50">
                            <p class="font-semibold">Responsable: ${r.responsable || 'An√≥nimo'}</p>
                            <p class="text-sm text-gray-600">Fecha: ${r.timestamp ? r.timestamp.toDate().toLocaleString('es-ES') : 'N/A'}</p>
                            <ul class="list-disc list-inside text-sm mt-2">
                                <li>SOC: ${r.soc}</li>
                                <li>Actos Inseguros: ${r.actosInseguros}</li>
                                <li>NEAR MISS: ${r.nearMiss}</li>
                                <li>Accidentes: ${r.accidentes || 0}</li>
                                <li>Resumen: ${r.resumen || 'Sin resumen'}</li>
                            </ul>
                        </div>
                    `).join('')}
                </div>

                <h2 class="text-xl font-bold mb-2">Conclusiones Autom√°ticas</h2>
                <div class="mb-6">${generatedConclusions}</div>

                <h2 class="text-xl font-bold mb-2">Recomendaciones Autom√°ticas</h2>
                <div>${generatedRecommendations}</div>
            `;
            
            contentDiv.innerHTML = reportHtml;
            reportModal.classList.remove('hidden');
        }

        function exportToWord() {
            const content = document.getElementById('detailed-report-content').innerHTML;
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial, sans-serif; font-size: 11pt; }
                    h1 { font-size: 16pt; color: #1e3a8a; }
                    h2 { font-size: 14pt; color: #1e40af; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-top: 20px;}
                    ul { list-style-type: disc; margin-left: 20px; }
                    p { margin-bottom: 10px; line-height: 1.5; }
                    div.p-4 { padding: 1rem; }
                    div.border { border: 1px solid #e5e7eb; }
                    div.rounded-md { border-radius: 0.375rem; }
                    div.bg-gray-50 { background-color: #f9fafb; margin-bottom: 1rem; }
                    p.font-semibold { font-weight: 600; }
                    p.text-sm { font-size: 0.875rem; }
                    p.text-gray-600 { color: #4b5563; }
                    ul.mt-2 { margin-top: 0.5rem; }
                </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;

            try {
                const fileBuffer = htmlDocx.asBlob(fullHtml);
                const link = document.createElement('a');
                const url = URL.createObjectURL(fileBuffer);
                link.href = url;
                link.download = 'Informe_de_Gestion.docx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showMessage('Informe exportado a Word.');
            } catch (error) {
                console.error("Error exporting to Word:", error);
                showMessage('Error al exportar a Word.');
            }
        }

    </script>
</body>
</html>
